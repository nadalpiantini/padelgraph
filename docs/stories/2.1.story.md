# Story 2.1: Analytics Database Schema

**Epic**: 2 - Analytics Engine
**Story ID**: 2.1
**Status**: Draft
**Priority**: High
**Estimated Effort**: 3-4 hours

---

## ðŸ“– User Story

**As a** system
**I want** analytics tracking tables
**So that** we can capture user behavior and events

---

## âœ… Acceptance Criteria

1. analytics_events table created
2. user_sessions table created
3. funnel_steps table created
4. Indexes for performance
5. RLS policies configured
6. Migration applied

---

## ðŸ”§ Dev Notes

**Migration**: `supabase/migrations/027_analytics_schema.sql`

**Tables**:
```sql
CREATE TABLE analytics_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_name TEXT NOT NULL,
  user_id UUID REFERENCES user_profile(id),
  session_id TEXT NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  properties JSONB DEFAULT '{}'::jsonb,
  page_url TEXT,
  referrer TEXT,
  device_info JSONB
);

CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT UNIQUE NOT NULL,
  user_id UUID REFERENCES user_profile(id),
  started_at TIMESTAMPTZ DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  page_views INTEGER DEFAULT 1,
  events_count INTEGER DEFAULT 0,
  duration_seconds INTEGER,
  entry_url TEXT,
  exit_url TEXT,
  referrer TEXT,
  device_info JSONB
);

CREATE TABLE funnel_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  funnel_name TEXT NOT NULL,
  step_name TEXT NOT NULL,
  step_order INTEGER NOT NULL,
  user_id UUID REFERENCES user_profile(id),
  session_id TEXT NOT NULL,
  completed_at TIMESTAMPTZ DEFAULT NOW(),
  properties JSONB
);
```

---

## ðŸ“‹ Tasks

1. Create migration file
2. Add all 3 tables
3. Add performance indexes
4. Add RLS policies
5. Apply migration
6. Verify in Supabase
7. Create TypeScript types

---

**Created**: 2025-10-18
