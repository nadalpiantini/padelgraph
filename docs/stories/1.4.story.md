# Story 1.4: Create Subscription Flow API

**Epic**: 1 - PayPal Integration
**Story ID**: 1.4
**Status**: Draft
**Priority**: Critical
**Estimated Effort**: 4-5 hours
**Dependencies**: Story 1.3 (Plans API), Story 1.1 (PayPal config)

---

## üìñ User Story

**As a** user
**I want** to subscribe to a paid plan
**So that** I can access premium features

---

## ‚úÖ Acceptance Criteria

1. POST /api/subscriptions/create endpoint implemented
2. Creates PayPal subscription via SDK
3. Saves subscription to database
4. Returns approval URL for user redirect
5. Handles errors gracefully
6. Validates plan_id input
7. Prevents duplicate active subscriptions
8. Creates initial usage_log entry

---

## üîß Dev Notes

### API Implementation

**File**: `src/app/api/subscriptions/create/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
import { getPayPalClient } from '@/lib/paypal/client';
import { SUBSCRIPTION_PLANS } from '@/lib/paypal/plans';

const CreateSubscriptionSchema = z.object({
  plan_id: z.enum(['pro', 'premium', 'club']),
  return_url: z.string().url(),
  cancel_url: z.string().url(),
});

export async function POST(request: NextRequest) {
  try {
    // 1. Authenticate user
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Validate request
    const body = await request.json();
    const { plan_id, return_url, cancel_url } = CreateSubscriptionSchema.parse(body);

    // 3. Check for existing active subscription
    const { data: existing } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', user.id)
      .eq('status', 'active')
      .single();

    if (existing) {
      return NextResponse.json(
        { error: 'User already has an active subscription' },
        { status: 400 }
      );
    }

    // 4. Get plan details
    const plan = SUBSCRIPTION_PLANS.find(p => p.id === plan_id);
    if (!plan || !plan.paypal_plan_id) {
      return NextResponse.json({ error: 'Invalid plan' }, { status: 400 });
    }

    // 5. Create PayPal subscription
    const paypalClient = getPayPalClient();
    const subscriptionsRequest = {
      plan_id: plan.paypal_plan_id,
      subscriber: {
        email_address: user.email,
      },
      application_context: {
        brand_name: 'Padelgraph',
        return_url,
        cancel_url,
        user_action: 'SUBSCRIBE_NOW',
      },
    };

    const response = await paypalClient.execute(subscriptionsRequest);

    // 6. Save to database
    const { data: subscription, error: dbError } = await supabase
      .from('subscriptions')
      .insert({
        user_id: user.id,
        paypal_subscription_id: response.result.id,
        paypal_plan_id: plan.paypal_plan_id,
        plan_id: plan.id,
        status: 'pending', // Will be 'active' after webhook
        current_period_start: new Date().toISOString(),
      })
      .select()
      .single();

    if (dbError) {
      console.error('Database error:', dbError);
      return NextResponse.json({ error: 'Failed to save subscription' }, { status: 500 });
    }

    // 7. Log usage event
    await supabase.from('usage_logs').insert({
      user_id: user.id,
      feature: 'subscription',
      action: 'created',
      metadata: { plan_id, subscription_id: subscription.id },
    });

    // 8. Return approval URL
    const approvalLink = response.result.links.find(link => link.rel === 'approve');

    return NextResponse.json({
      subscription_id: subscription.id,
      approval_url: approvalLink?.href,
      paypal_subscription_id: response.result.id,
    });

  } catch (error) {
    console.error('Create subscription error:', error);
    return NextResponse.json(
      { error: 'Failed to create subscription' },
      { status: 500 }
    );
  }
}
```

[Source: Existing API pattern in src/app/api/feed/route.ts]

---

## üìã Tasks / Subtasks

### Task 1: Create API Route File (AC: 1)
1. Create `src/app/api/subscriptions/create/route.ts`
2. Import dependencies
3. Define request validation schema

### Task 2: Implement Authentication (AC: 1)
1. Get Supabase client
2. Check user auth
3. Return 401 if unauthorized

### Task 3: Validate Request Body (AC: 6)
1. Parse request JSON
2. Validate with Zod schema
3. Return 400 if invalid

### Task 4: Check Existing Subscription (AC: 7)
1. Query subscriptions table
2. Check for active subscription
3. Return error if exists

### Task 5: Create PayPal Subscription (AC: 2, 4)
1. Get PayPal client
2. Get plan details from config
3. Create subscription request
4. Execute via PayPal SDK
5. Extract approval URL

### Task 6: Save to Database (AC: 3)
1. Insert into subscriptions table
2. Set status = 'pending'
3. Handle database errors

### Task 7: Log Usage Event (AC: 8)
1. Insert into usage_logs
2. Record subscription creation

### Task 8: Return Response (AC: 4, 5)
1. Format response JSON
2. Include approval_url
3. Include subscription_id
4. Return 200 status

### Task 9: Unit Tests (AC: 1-8)
1. Create `__tests__/api/subscriptions/create.test.ts`
2. Test: Successful subscription creation
3. Test: Invalid plan_id rejected
4. Test: Duplicate subscription prevented
5. Test: Unauthorized access blocked
6. Test: Error handling
7. Run tests

---

## üß™ Testing Strategy

**Unit Tests**: Mock PayPal SDK, Supabase client
**Integration Test**: Use PayPal Sandbox
**Manual Test**: Full flow end-to-end

---

## üìù Definition of Done

- [ ] API endpoint created
- [ ] PayPal SDK integration working
- [ ] Database save successful
- [ ] Returns correct approval URL
- [ ] Duplicate subscription prevented
- [ ] All validations working
- [ ] Unit tests passing
- [ ] Integration test successful
- [ ] Error handling robust
- [ ] Code committed

---

**Created**: 2025-10-18
**Agent**: Bob
**Source**: Epic 1, SPRINT_5_PRD.md Phase 1.4
