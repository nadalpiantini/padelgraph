# Story 1.2: Database Schema - Subscription Tables

**Epic**: 1 - PayPal Integration
**Story ID**: 1.2
**Status**: Draft
**Priority**: Critical
**Estimated Effort**: 3-4 hours
**Dependencies**: Story 1.1 (PayPal config)

---

## üìñ User Story

**As a** system
**I want** subscription and payment tracking tables in the database
**So that** we can persist subscription state and payment history

---

## ‚úÖ Acceptance Criteria

1. `subscriptions` table created with all required fields
2. `usage_logs` table created for feature usage tracking
3. `payments` table created for payment history
4. `paypal_webhook_events` table created for event logging
5. All indexes created for performance
6. RLS policies configured for security
7. Migration file applied successfully
8. Tables verified in Supabase dashboard

---

## üîß Dev Notes

### Database Schema Design

**Migration File**: `supabase/migrations/026_paypal_subscriptions.sql`
[Source: Existing migration pattern in supabase/migrations/]

### Table: subscriptions

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES user_profile(id) ON DELETE CASCADE,

  -- PayPal IDs
  paypal_customer_id TEXT,
  paypal_subscription_id TEXT UNIQUE,
  paypal_plan_id TEXT NOT NULL,

  -- Plan info
  plan_id TEXT NOT NULL CHECK (plan_id IN ('free', 'pro', 'premium', 'club')),
  status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'suspended', 'past_due', 'expired')),

  -- Billing period
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,

  -- Cancellation
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  canceled_at TIMESTAMPTZ,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  UNIQUE(user_id, status) WHERE status = 'active' -- Only one active subscription per user
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_paypal_id ON subscriptions(paypal_subscription_id);
```

[Source: SPRINT_5_PRD.md Phase 1.3]

### Table: usage_logs

```sql
CREATE TABLE usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES user_profile(id) ON DELETE CASCADE,

  -- Feature tracking
  feature TEXT NOT NULL CHECK (feature IN ('tournament', 'auto_match', 'recommendation', 'travel_plan')),
  action TEXT NOT NULL,

  -- Timing
  timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- Additional data
  metadata JSONB DEFAULT '{}'::jsonb
);

CREATE INDEX idx_usage_logs_user_id ON usage_logs(user_id);
CREATE INDEX idx_usage_logs_feature ON usage_logs(feature);
CREATE INDEX idx_usage_logs_timestamp ON usage_logs(timestamp DESC);
CREATE INDEX idx_usage_logs_user_feature ON usage_logs(user_id, feature);
```

[Source: SPRINT_5_PRD.md Phase 1.3]

### Table: payments

```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES user_profile(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,

  -- PayPal IDs
  paypal_payment_id TEXT UNIQUE,
  paypal_order_id TEXT,

  -- Amount
  amount INTEGER NOT NULL, -- in cents
  currency TEXT NOT NULL DEFAULT 'EUR',

  -- Status
  status TEXT NOT NULL CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);

CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_created_at ON payments(created_at DESC);
```

[Source: SPRINT_5_PRD.md Phase 1.3]

### Table: paypal_webhook_events

```sql
CREATE TABLE paypal_webhook_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- PayPal event data
  event_id TEXT UNIQUE NOT NULL,
  event_type TEXT NOT NULL,
  resource_type TEXT,

  -- Full payload
  payload JSONB NOT NULL,

  -- Processing status
  processed BOOLEAN DEFAULT FALSE,
  processed_at TIMESTAMPTZ,
  error TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_webhook_events_event_id ON paypal_webhook_events(event_id);
CREATE INDEX idx_webhook_events_event_type ON paypal_webhook_events(event_type);
CREATE INDEX idx_webhook_events_processed ON paypal_webhook_events(processed);
CREATE INDEX idx_webhook_events_created_at ON paypal_webhook_events(created_at DESC);
```

[Source: SPRINT_5_PRD.md Phase 1.3]

### RLS Policies

**subscriptions table**:
```sql
-- Users can view their own subscriptions
CREATE POLICY "Users can view own subscriptions"
  ON subscriptions FOR SELECT
  USING (auth.uid() = user_id);

-- Only system can insert/update (via API)
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
```

**payments table**:
```sql
-- Users can view their own payments
CREATE POLICY "Users can view own payments"
  ON payments FOR SELECT
  USING (auth.uid() = user_id);

ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
```

**usage_logs table**:
```sql
-- Users can view their own usage
CREATE POLICY "Users can view own usage"
  ON usage_logs FOR SELECT
  USING (auth.uid() = user_id);

ALTER TABLE usage_logs ENABLE ROW LEVEL SECURITY;
```

**webhook_events table**:
```sql
-- Admin only (no user access)
ALTER TABLE paypal_webhook_events ENABLE ROW LEVEL SECURITY;
-- No SELECT policy - admin/system only
```

[Source: Existing RLS pattern in migrations/021_social_feed_rls.sql]

---

## üìã Tasks / Subtasks

### Task 1: Create Migration File (AC: 7)
1. Create `supabase/migrations/026_paypal_subscriptions.sql`
2. Add table creation SQL
3. Add indexes
4. Add RLS policies
5. Add helpful comments

### Task 2: Apply Migration (AC: 7, 8)
1. Run migration script: `npm run tsx scripts/apply-migrations-supabase.ts`
2. Verify in Supabase dashboard
3. Check all tables exist
4. Check indexes created
5. Verify RLS enabled

### Task 3: Create TypeScript Types (AC: 8)
1. Create `src/lib/paypal/types.ts`
2. Define `Subscription` interface (matching DB schema)
3. Define `UsageLog` interface
4. Define `Payment` interface
5. Define `WebhookEvent` interface
6. Export all types

### Task 4: Unit Tests for Migration (AC: 8)
1. Create `__tests__/migrations/026_paypal_subscriptions.test.ts`
2. Test: Tables exist
3. Test: Indexes exist
4. Test: RLS policies active
5. Run tests

---

## üß™ Testing Strategy

**Migration Testing**:
```sql
-- Verify tables
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('subscriptions', 'usage_logs', 'payments', 'paypal_webhook_events');

-- Verify indexes
SELECT indexname FROM pg_indexes
WHERE tablename = 'subscriptions';

-- Verify RLS
SELECT tablename, policyname FROM pg_policies
WHERE tablename IN ('subscriptions', 'payments', 'usage_logs');
```

**Type Testing**:
```typescript
// Verify types match DB schema
const testSubscription: Subscription = {
  id: '...',
  user_id: '...',
  plan_id: 'pro',
  status: 'active',
  // ... all required fields
};
```

---

## üìù Definition of Done

- [ ] Migration file created
- [ ] All 4 tables created in database
- [ ] All indexes created
- [ ] RLS policies configured
- [ ] Migration applied successfully
- [ ] TypeScript types created
- [ ] Types exported and available
- [ ] Unit tests written
- [ ] All tests passing
- [ ] Verified in Supabase dashboard
- [ ] Code committed to git

---

## üîó Related Stories

**Previous**: Story 1.1 (PayPal Configuration)
**Next**: Story 1.3 (Subscription Plans API)
**Blocks**: Stories 1.4-1.12

---

**Created**: 2025-10-18
**Agent**: Bob (Scrum Master)
**Source**: Epic 1, SPRINT_5_PRD.md Phase 1.3
