# Story 1.1: PayPal Configuration & Environment Setup

**Epic**: 1 - PayPal Integration & Subscription System
**Story ID**: 1.1
**Status**: Draft
**Priority**: Critical
**Estimated Effort**: 2-3 hours
**Dependencies**: None

---

## üìñ User Story

**As a** platform administrator
**I want** PayPal Sandbox and Production environments configured
**So that** we can process subscription payments securely

---

## ‚úÖ Acceptance Criteria

1. PayPal Developer account created and verified
2. PayPal Sandbox app created with API credentials
3. PayPal Production app created (ready for go-live)
4. Environment variables configured in Vercel + local
5. PayPal SDK initialized and tested
6. Webhook URL registered in PayPal dashboard
7. Connection test successful (auth + basic API call)

---

## üîß Dev Notes

### Environment Configuration

**Environment Variables Required**:
```bash
# PayPal Sandbox
PAYPAL_SANDBOX_CLIENT_ID=xxxxx
PAYPAL_SANDBOX_CLIENT_SECRET=xxxxx
PAYPAL_SANDBOX_WEBHOOK_ID=xxxxx

# PayPal Production (for later)
PAYPAL_CLIENT_ID=xxxxx
PAYPAL_CLIENT_SECRET=xxxxx
PAYPAL_WEBHOOK_ID=xxxxx

# Environment flag
PAYPAL_MODE=sandbox # or 'production'
```

**File Location**: `.env.local` (local), Vercel Environment Variables (production)
[Source: BMAD tech-stack.md - Environment management]

### PayPal SDK Setup

**Library**: `@paypal/checkout-server-sdk` (already installed)
[Source: package.json dependencies]

**Initialization Pattern**:
```typescript
// src/lib/paypal/client.ts
import paypal from '@paypal/checkout-server-sdk';

function getPayPalEnvironment() {
  const clientId = process.env.PAYPAL_MODE === 'production'
    ? process.env.PAYPAL_CLIENT_ID!
    : process.env.PAYPAL_SANDBOX_CLIENT_ID!;

  const clientSecret = process.env.PAYPAL_MODE === 'production'
    ? process.env.PAYPAL_CLIENT_SECRET!
    : process.env.PAYPAL_SANDBOX_CLIENT_SECRET!;

  return process.env.PAYPAL_MODE === 'production'
    ? new paypal.core.LiveEnvironment(clientId, clientSecret)
    : new paypal.core.SandboxEnvironment(clientId, clientSecret);
}

export function getPayPalClient() {
  return new paypal.core.PayPalHttpClient(getPayPalEnvironment());
}
```

### Testing Requirements

**Test Cases**:
1. Client initialization (sandbox mode)
2. Client initialization (production mode)
3. Environment variable validation
4. Error handling for missing credentials
5. Basic API call (get client token)

[Source: architecture/coding-standards.md - Testing standards]

### File Structure

**New Files to Create**:
```
src/lib/paypal/
‚îú‚îÄ client.ts          # PayPal SDK client
‚îú‚îÄ types.ts           # PayPal-specific types
‚îî‚îÄ config.ts          # Configuration helpers

__tests__/lib/paypal/
‚îî‚îÄ client.test.ts     # Unit tests
```

[Source: architecture/source-tree.md - Library organization]

### Security Considerations

- **Never** commit credentials to git
- Use `.env.example` template without real values
- Rotate credentials if accidentally exposed
- Validate environment before API calls
- Use Sandbox for all development/testing

[Source: architecture/coding-standards.md - Security standards]

---

## üìã Tasks / Subtasks

### Task 1: Create PayPal Developer Account (AC: 1)
1. Visit https://developer.paypal.com
2. Sign up or log in
3. Navigate to Dashboard ‚Üí My Apps & Credentials
4. Create Sandbox app: "Padelgraph Sandbox"
5. Save Client ID and Secret securely

### Task 2: Create PayPal Production App (AC: 2, 3)
1. In same developer dashboard
2. Switch to "Live" tab
3. Create Production app: "Padelgraph Production"
4. Save Client ID and Secret (for later use)
5. Note: Production app needs business verification

### Task 3: Configure Environment Variables (AC: 4)
1. Create `.env.local` file (if not exists)
2. Add PayPal Sandbox variables
3. Add PayPal Production variables (commented out)
4. Add PAYPAL_MODE=sandbox
5. Update `.env.example` template
6. Configure in Vercel dashboard (Sandbox for now)

### Task 4: Initialize PayPal SDK Client (AC: 5)
1. Create `src/lib/paypal/client.ts`
2. Implement environment selection logic
3. Implement `getPayPalClient()` function
4. Add error handling for missing env vars
5. Export client factory

### Task 5: Create PayPal Types File (AC: 5)
1. Create `src/lib/paypal/types.ts`
2. Define `PayPalMode` type
3. Define `PayPalCredentials` interface
4. Export all types

### Task 6: Register Webhook URL (AC: 6)
1. In PayPal Dashboard ‚Üí Webhooks
2. Create webhook for Sandbox
3. URL: `https://padelgraph.com/api/paypal/webhook`
4. Subscribe to events: BILLING.*, PAYMENT.*
5. Save Webhook ID to env vars
6. Repeat for Production (later)

### Task 7: Connection Test (AC: 7)
1. Create test script: `scripts/test-paypal-connection.ts`
2. Initialize PayPal client
3. Make test API call (generate client token)
4. Log success/failure
5. Run: `npx tsx scripts/test-paypal-connection.ts`

### Task 8: Write Unit Tests (AC: 7)
1. Create `__tests__/lib/paypal/client.test.ts`
2. Test: client initialization (sandbox)
3. Test: client initialization (production)
4. Test: environment variable validation
5. Test: error handling for missing credentials
6. Run: `npm run test`

---

## üß™ Testing Strategy

**Unit Tests**: `__tests__/lib/paypal/client.test.ts`
- Test both sandbox and production modes
- Mock environment variables
- Verify error handling

**Manual Testing**:
1. Run connection test script
2. Verify credentials work
3. Check Vercel env vars are set

**Validation**:
- [ ] All env vars present
- [ ] SDK initializes without errors
- [ ] Test API call succeeds
- [ ] Unit tests passing

---

## üìù Definition of Done

- [ ] PayPal Developer accounts created (Sandbox + Production)
- [ ] All environment variables configured
- [ ] PayPal SDK client implemented
- [ ] Webhook URLs registered
- [ ] Connection test passes
- [ ] Unit tests written and passing
- [ ] `.env.example` updated
- [ ] Documentation added to README
- [ ] Code reviewed and merged
- [ ] Deployed to Vercel (Sandbox mode)

---

## üîó Related Stories

**Next**: Story 1.2 (Database Schema - Subscriptions)
**Blocks**: All other PayPal stories (1.2-1.12)

---

## üí° Implementation Notes

**PayPal Dashboard Access**:
- Sandbox: https://developer.paypal.com/dashboard/applications/sandbox
- Production: https://developer.paypal.com/dashboard/applications/live

**Webhook Events to Subscribe**:
- BILLING.SUBSCRIPTION.CREATED
- BILLING.SUBSCRIPTION.ACTIVATED
- BILLING.SUBSCRIPTION.UPDATED
- BILLING.SUBSCRIPTION.CANCELLED
- BILLING.SUBSCRIPTION.SUSPENDED
- BILLING.SUBSCRIPTION.EXPIRED
- PAYMENT.SALE.COMPLETED
- PAYMENT.SALE.REFUNDED

**Security Reminders**:
- Never log full credentials
- Use environment variable validation
- Rotate keys if exposed
- Keep Production credentials separate from Sandbox

---

**Created**: 2025-10-18
**Agent**: Bob (Scrum Master)
**Source**: Epic 1, SPRINT_5_PRD.md Phase 1.1
