# Story 1.3: Subscription Plans API

**Epic**: 1 - PayPal Integration
**Story ID**: 1.3
**Status**: Draft
**Priority**: High
**Estimated Effort**: 2-3 hours
**Dependencies**: Story 1.2 (Database schema)

---

## ðŸ“– User Story

**As a** potential subscriber
**I want** to view available subscription plans
**So that** I can choose the plan that fits my needs

---

## âœ… Acceptance Criteria

1. GET /api/subscriptions/plans endpoint created
2. Returns all 4 plans (Free, Pro, Premium, Club)
3. Each plan includes features, pricing, limits
4. Response is properly typed (Zod validation)
5. Free plan is default for new users
6. API is publicly accessible (no auth required)
7. Response time <100ms

---

## ðŸ”§ Dev Notes

### API Endpoint

**File**: `src/app/api/subscriptions/plans/route.ts`
[Source: architecture/source-tree.md - API routes]

**Pattern**: Follow existing API pattern from `src/app/api/recommendations/route.ts`

### Response Schema

```typescript
interface SubscriptionPlan {
  id: 'free' | 'pro' | 'premium' | 'club';
  name: string;
  price: number; // in EUR
  currency: string;
  interval: 'month' | 'year';
  features: {
    tournaments: number | 'unlimited';
    auto_match: number | 'unlimited';
    recommendations: number | 'unlimited';
    travel_plans: number | 'unlimited';
    analytics?: boolean;
    priority_support?: boolean;
    custom_branding?: boolean;
    api_access?: boolean;
    club_management?: boolean;
    coach_tools?: boolean;
  };
  popular?: boolean; // Badge for recommended plan
  paypal_plan_id?: string; // For paid plans
}

// API Response
interface PlansResponse {
  plans: SubscriptionPlan[];
  default_plan: 'free';
}
```

[Source: SPRINT_5_PRD.md Phase 1.2]

### Plan Configuration

**File**: `src/lib/paypal/plans.ts`

```typescript
export const SUBSCRIPTION_PLANS: SubscriptionPlan[] = [
  {
    id: 'free',
    name: 'Free',
    price: 0,
    currency: 'EUR',
    interval: 'month',
    features: {
      tournaments: 2,
      auto_match: 3,
      recommendations: 10,
      travel_plans: 1,
    },
  },
  {
    id: 'pro',
    name: 'Pro',
    price: 9.99,
    currency: 'EUR',
    interval: 'month',
    popular: true,
    paypal_plan_id: process.env.PAYPAL_PRO_PLAN_ID,
    features: {
      tournaments: 'unlimited',
      auto_match: 20,
      recommendations: 100,
      travel_plans: 10,
      analytics: true,
      priority_support: true,
    },
  },
  {
    id: 'premium',
    name: 'Premium',
    price: 19.99,
    currency: 'EUR',
    interval: 'month',
    paypal_plan_id: process.env.PAYPAL_PREMIUM_PLAN_ID,
    features: {
      tournaments: 'unlimited',
      auto_match: 'unlimited',
      recommendations: 'unlimited',
      travel_plans: 'unlimited',
      analytics: true,
      priority_support: true,
      custom_branding: true,
      api_access: true,
    },
  },
  {
    id: 'club',
    name: 'Club',
    price: 99.99,
    currency: 'EUR',
    interval: 'month',
    paypal_plan_id: process.env.PAYPAL_CLUB_PLAN_ID,
    features: {
      tournaments: 'unlimited',
      auto_match: 'unlimited',
      recommendations: 'unlimited',
      travel_plans: 'unlimited',
      analytics: true,
      priority_support: true,
      custom_branding: true,
      api_access: true,
      club_management: true,
      coach_tools: true,
    },
  },
];
```

### Validation Schema

**File**: `src/lib/validations/subscription.ts`

```typescript
import { z } from 'zod';

export const SubscriptionPlanSchema = z.object({
  id: z.enum(['free', 'pro', 'premium', 'club']),
  name: z.string(),
  price: z.number().min(0),
  currency: z.string(),
  interval: z.enum(['month', 'year']),
  features: z.object({
    tournaments: z.union([z.number(), z.literal('unlimited')]),
    auto_match: z.union([z.number(), z.literal('unlimited')]),
    recommendations: z.union([z.number(), z.literal('unlimited')]),
    travel_plans: z.union([z.number(), z.literal('unlimited')]),
    analytics: z.boolean().optional(),
    priority_support: z.boolean().optional(),
    custom_branding: z.boolean().optional(),
    api_access: z.boolean().optional(),
    club_management: z.boolean().optional(),
    coach_tools: z.boolean().optional(),
  }),
  popular: z.boolean().optional(),
  paypal_plan_id: z.string().optional(),
});

export const PlansResponseSchema = z.object({
  plans: z.array(SubscriptionPlanSchema),
  default_plan: z.literal('free'),
});
```

[Source: Existing validation pattern in src/lib/validations/]

---

## ðŸ“‹ Tasks / Subtasks

### Task 1: Create Migration File (AC: 1-4)
1. Create `supabase/migrations/026_paypal_subscriptions.sql`
2. Add subscriptions table SQL
3. Add usage_logs table SQL
4. Add payments table SQL
5. Add paypal_webhook_events table SQL
6. Add all indexes
7. Add RLS policies

### Task 2: Apply Migration (AC: 7, 8)
1. Run `npm run tsx scripts/apply-migrations-supabase.ts`
2. Verify success in console
3. Open Supabase dashboard
4. Check Table Editor â†’ verify all 4 tables
5. Check indexes in Database â†’ Indexes

### Task 3: Create Plan Configuration (AC: 2, 3)
1. Create `src/lib/paypal/plans.ts`
2. Define SUBSCRIPTION_PLANS array
3. Add all 4 plans with features
4. Export plans configuration
5. Add type exports

### Task 4: Create Validation Schemas (AC: 4)
1. Create `src/lib/validations/subscription.ts`
2. Define SubscriptionPlanSchema with Zod
3. Define PlansResponseSchema
4. Export all schemas

### Task 5: Implement API Endpoint (AC: 1, 6)
1. Create `src/app/api/subscriptions/plans/route.ts`
2. Implement GET handler
3. Return SUBSCRIPTION_PLANS
4. Add response validation
5. No auth required (public endpoint)

### Task 6: Unit Tests (AC: 7)
1. Create `__tests__/lib/paypal/plans.test.ts`
2. Test: All 4 plans defined
3. Test: Free plan has correct limits
4. Test: Paid plans have paypal_plan_id
5. Test: Validation schemas work
6. Create `__tests__/api/subscriptions/plans.test.ts`
7. Test: GET returns all plans
8. Test: Response matches schema
9. Run tests

---

## ðŸ§ª Testing Strategy

**Unit Tests**:
- Plans configuration validity
- Zod schema validation
- API response format

**Integration Test**:
```bash
curl http://localhost:3000/api/subscriptions/plans
# Should return all 4 plans
```

**Manual Verification**:
1. Visit `/api/subscriptions/plans` in browser
2. Verify JSON response
3. Check all plans present
4. Validate pricing and features

---

## ðŸ“ Definition of Done

- [ ] Migration created and applied
- [ ] All 4 database tables exist
- [ ] Indexes and RLS configured
- [ ] Plans configuration created
- [ ] Validation schemas created
- [ ] API endpoint implemented
- [ ] API returns correct data
- [ ] Unit tests written and passing
- [ ] Integration test successful
- [ ] Code reviewed
- [ ] Documentation updated

---

## ðŸ”— Related Stories

**Previous**: Story 1.2 (Database Schema)
**Next**: Story 1.4 (Create Subscription Flow)

---

**Created**: 2025-10-18
**Agent**: Bob (Scrum Master)
**Source**: Epic 1, SPRINT_5_PRD.md Phase 1.2, 1.4
